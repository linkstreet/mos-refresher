angular.module("mos.mobile.components",[]).directive("mosRefresher",["$ionicGesture",function(e){return{restrict:"E",template:"<div ng-transclude></div>",require:"?^$ionicScroll",transclude:!0,scope:{onRefresh:"&",onDragStart:"&",onDrag:"&",onRelease:"&",onRefreshChange:"&",onHiding:"&",onFinish:"&"},controller:["$scope",function(e){this.addListener=function(n){e.listener=n}}],link:function(n,s,t,r){function a(e,s){if(n.listener&&n.listener[e]){var t=new Event(e,{cancelable:!0});t.params=s;var r=n.listener[e].apply(n.listener,[t]);if(t.defaultPrevented)return r}return n[e]?n[e].apply(n,[s]):void 0}function o(e){if("ion-content"===e[0].localName)return e;var n=e.parent();return n?o(n):null}function i(){D&&(n.listener=null,e.off(D.start,"dragstart",u),e.off(D.down,"dragdown",m),e.off(D.end,"dragend",h),s.off("transitionend",f),s.off("$destroy",i))}function d(){if(p=o(s),!p)throw new Error("Refresher must be a child of ion-content");C=angular.element(s[0].querySelector(".mos-rotate")),s.on("$destroy",i),D={start:e.on("dragstart",u,p),down:e.on("dragdown",m,p),end:e.on("dragend",h,p),transitionEnd:s.on("transitionend",f)},l()}function l(){s.children().addClass("mos-content"),s.addClass("mos-hidden"),v()}function f(){s.hasClass("mos-hiding")&&(s.addClass("mos-hidden"),s.removeClass("mos-hiding"),a("onFinish"))}function c(e,n){e.css({"-webkit-transform":n,"-moz-transform":n,"-ms-transform":n,transform:n})}function u(){var e=r?r.getScrollPosition().top:p[0].scrollTop;e<=S.maxStartY&&(0===C.length&&(C=angular.element(s[0].querySelector(".mos-rotate"))),w.enabled=!0,s.removeClass("mos-hidden"),s.addClass("mos-dragging"),a("onDragStart"))}function h(e){w.enabled&&(e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),w.enabled=!1,s.removeClass("mos-dragging"),c(C,""),a("onRelease"),w.mustRefresh?g():v())}function m(e){if(w.enabled){e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),w.distance=e.gesture.distance/S.resistance;var n=100*w.distance/S.distanceToRefresh;w.distance<=S.distanceToRefresh+S.extraDistance&&(R(w.distance),c(C,"rotate("+3.6*n+"deg)"),a("onDrag",{distance:w.distance,percentage:n})),w.distance>S.distanceToRefresh?w.mustRefresh||(s.addClass("mos-refresh"),w.mustRefresh=!0,a("onRefreshChange",{willRefresh:!0})):w.mustRefresh&&(s.removeClass("mos-refresh"),w.mustRefresh=!1,a("onRefreshChange",{willRefresh:!1}))}}function g(){s.addClass("mos-refreshing"),R(S.distanceToRefresh);var e=a("onRefresh");e&&e.then&&e.then(function(){v()})}function v(){n.loading=!1,w={enabled:!1,distance:0,mustRefresh:!1},s.removeClass("mos-refresh mos-refreshing mos-dragging"),s.hasClass("mos-hidden")||(s.addClass("mos-hiding"),a("onHiding")),R(0)}function R(e){c(s,"translate3d( 0, "+(e-s[0].offsetHeight-2)+"px, 0 )")}var p,C,w,D,b={distance:60,overflow:80,resistance:2.5,startPos:70},S={distanceToRefresh:parseInt(t.distance)||b.distance,overflow:parseInt(t.overflow)||b.overflow,resistance:parseFloat(t.resistance)||b.resistance,maxStartY:parseInt(t.startPos)||b.startPos};S.extraDistance=S.distanceToRefresh*S.overflow/100,d()}}}]);