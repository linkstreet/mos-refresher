angular.module("mos.mobile.components",[]).constant("MOS_REFRESHER_CONFIG",{defaults:{distance:60,overflow:80,resistance:2.5,startPos:70},hidingTime:300}).directive("mosRefresher",["$ionicGesture","$timeout","MOS_REFRESHER_CONFIG",function(e,s,n){return{restrict:"E",template:"<div ng-transclude></div>",require:"?^$ionicScroll",transclude:!0,scope:{onRefresh:"&",onDragStart:"&",onDrag:"&",onRelease:"&",onRefreshChange:"&",onHiding:"&",onFinish:"&"},controller:["$scope",function(e){this.addListener=function(s){e.listener=s}}],link:function(r,t,o,a){function i(e,s){if(r.listener&&r.listener[e]){var n=new Event(e,{cancelable:!0});n.params=s;var t=r.listener[e].apply(r.listener,[n]);if(n.defaultPrevented)return t}return r[e]?r[e].apply(r,[s]):void 0}function l(e){if("ion-content"===e[0].localName)return e;var s=e.parent();return s?l(s):null}function d(){D&&(r.listener=null,F&&s.cancel(F),e.off(D.start,"dragstart",u),e.off(D.down,"dragdown",v),e.off(D.end,"dragend",g),E.off("scroll",R),t.off("transitionend",h),t.off("$destroy",d))}function f(){if(E=l(t),!E)throw new Error("Refresher must be a child of ion-content");S=angular.element(t[0].querySelector(".mos-rotate")),t.on("$destroy",d),D={start:e.on("dragstart",u,E),down:e.on("dragdown",v,E),end:e.on("dragend",g,E),transitionEnd:t.on("transitionend",h)},c()}function c(){t.children().addClass("mos-content"),t.addClass("mos-hidden"),C()}function h(e){t.hasClass("mos-hiding")&&(e&&F&&s.cancel(F),m(t,""),t.addClass("mos-hidden"),t.removeClass("mos-hiding mos-refreshed"),i("onFinish")),t.hasClass("mos-will-refresh")&&t.removeClass("mos-will-refresh")}function m(e,s){e.css({"-webkit-transform":s,"-moz-transform":s,"-ms-transform":s,transform:s})}function u(){var e=a?a.getScrollPosition().top:E[0].scrollTop;e<=$.maxStartY&&(y=a?0:e,0===S.length&&(S=angular.element(t[0].querySelector(".mos-rotate"))),T.enabled=!0,t.removeClass("mos-hidden"),t.addClass("mos-dragging"),i("onDragStart"),b=t[0].offsetHeight)}function g(e){T.enabled&&(e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),T.enabled=!1,t.removeClass("mos-dragging"),m(S,""),i("onRelease"),b=t[0].offsetHeight,T.mustRefresh?p():C(!1))}function v(e){if(T.enabled){e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),T.distance=e.gesture.distance/$.resistance;var s=100*T.distance/$.distanceToRefresh;T.distance<=$.distanceToRefresh+$.extraDistance&&(w(T.distance),m(S,"rotate("+3.6*s+"deg)"),i("onDrag",{distance:T.distance,percentage:s})),T.distance>$.distanceToRefresh?T.mustRefresh||(t.addClass("mos-refresh"),T.mustRefresh=!0,i("onRefreshChange",{willRefresh:!0})):T.mustRefresh&&(t.removeClass("mos-refresh"),T.mustRefresh=!1,i("onRefreshChange",{willRefresh:!1}))}}function R(e){y=e.srcElement.scrollTop,w($.distanceToRefresh)}function p(){t.addClass("mos-refreshing mos-will-refresh"),E.on("scroll",R),w($.distanceToRefresh);var e=i("onRefresh");e&&e.then&&e.then(function(){E.off("scroll",R),C(!0)})}function C(e){r.loading=!1,T={enabled:!1,distance:0,mustRefresh:!1},t.removeClass("mos-refresh mos-refreshing mos-dragging"),t.hasClass("mos-hidden")||(e&&t.addClass("mos-refreshed"),t.addClass("mos-hiding"),F=s(h,n.hidingTime),i("onHiding")),e?w($.distanceToRefresh,"scale(0.1)"):w(0)}function w(e,s){var n=t[0].offsetHeight;0===n&&(n=b),m(t,"translate3d( 0, "+(e+y-b-2)+"px, 0 )"+(s?" "+s:""))}var E,S,T,D,b,F,H=n.defaults,y=0,$={distanceToRefresh:parseInt(o.distance)||H.distance,overflow:parseInt(o.overflow)||H.overflow,resistance:parseFloat(o.resistance)||H.resistance,maxStartY:parseInt(o.startPos)||H.startPos};$.extraDistance=$.distanceToRefresh*$.overflow/100,f()}}}]);