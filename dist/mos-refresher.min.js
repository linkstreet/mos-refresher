angular.module("mos.mobile.components",[]).constant("MOS_REFRESHER_CONFIG",{defaults:{distance:60,overflow:80,resistance:2.5,startPos:70},hidingTime:300}).directive("mosRefresher",["$ionicGesture","$timeout","MOS_REFRESHER_CONFIG",function(e,n,s){return{restrict:"E",template:"<div ng-transclude></div>",require:"?^$ionicScroll",transclude:!0,scope:{onRefresh:"&",onDragStart:"&",onDrag:"&",onRelease:"&",onRefreshChange:"&",onHiding:"&",onFinish:"&"},controller:["$scope",function(e){this.addListener=function(n){e.listener=n}}],link:function(t,r,a,o){function i(e,n){if(t.listener&&t.listener[e]){var s=new Event(e,{cancelable:!0});s.params=n;var r=t.listener[e].apply(t.listener,[s]);if(s.defaultPrevented)return r}return t[e]?t[e].apply(t,[n]):void 0}function d(e){if("ion-content"===e[0].localName)return e;var n=e.parent();return n?d(n):null}function f(){D&&(t.listener=null,T&&n.cancel(T),e.off(D.start,"dragstart",m),e.off(D.down,"dragdown",v),e.off(D.end,"dragend",g),r.off("transitionend",u),r.off("$destroy",f))}function l(){if(w=d(r),!w)throw new Error("Refresher must be a child of ion-content");E=angular.element(r[0].querySelector(".mos-rotate")),r.on("$destroy",f),D={start:e.on("dragstart",m,w),down:e.on("dragdown",v,w),end:e.on("dragend",g,w),transitionEnd:r.on("transitionend",u)},c()}function c(){r.children().addClass("mos-content"),r.addClass("mos-hidden"),p()}function u(e){r.hasClass("mos-hiding")&&(e&&T&&n.cancel(T),r.addClass("mos-hidden"),r.removeClass("mos-hiding"),i("onFinish"))}function h(e,n){e.css({"-webkit-transform":n,"-moz-transform":n,"-ms-transform":n,transform:n})}function m(){var e=o?o.getScrollPosition().top:w[0].scrollTop;e<=H.maxStartY&&(0===E.length&&(E=angular.element(r[0].querySelector(".mos-rotate"))),S.enabled=!0,r.removeClass("mos-hidden"),r.addClass("mos-dragging"),i("onDragStart"),b=r[0].offsetHeight)}function g(e){S.enabled&&(e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),S.enabled=!1,r.removeClass("mos-dragging"),h(E,""),i("onRelease"),b=r[0].offsetHeight,S.mustRefresh?R():p())}function v(e){if(S.enabled){e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),S.distance=e.gesture.distance/H.resistance;var n=100*S.distance/H.distanceToRefresh;S.distance<=H.distanceToRefresh+H.extraDistance&&(C(S.distance),h(E,"rotate("+3.6*n+"deg)"),i("onDrag",{distance:S.distance,percentage:n})),S.distance>H.distanceToRefresh?S.mustRefresh||(r.addClass("mos-refresh"),S.mustRefresh=!0,i("onRefreshChange",{willRefresh:!0})):S.mustRefresh&&(r.removeClass("mos-refresh"),S.mustRefresh=!1,i("onRefreshChange",{willRefresh:!1}))}}function R(){r.addClass("mos-refreshing"),C(H.distanceToRefresh);var e=i("onRefresh");e&&e.then&&e.then(function(){p()})}function p(){t.loading=!1,S={enabled:!1,distance:0,mustRefresh:!1},r.removeClass("mos-refresh mos-refreshing mos-dragging"),r.hasClass("mos-hidden")||(r.addClass("mos-hiding"),T=n(u,s.hidingTime),i("onHiding")),C(0)}function C(e){var n=r[0].offsetHeight;0===n&&(n=b),h(r,"translate3d( 0, "+(e-b-2)+"px, 0 )")}var w,E,S,D,b,T,F=s.defaults,H={distanceToRefresh:parseInt(a.distance)||F.distance,overflow:parseInt(a.overflow)||F.overflow,resistance:parseFloat(a.resistance)||F.resistance,maxStartY:parseInt(a.startPos)||F.startPos};H.extraDistance=H.distanceToRefresh*H.overflow/100,l()}}}]);