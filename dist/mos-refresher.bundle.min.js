angular.module("mos.mobile.components",[]).directive("mosRefresher",["$ionicGesture",function(e){return{restrict:"E",template:"<div ng-transclude></div>",require:"?^$ionicScroll",transclude:!0,scope:{onRefresh:"&",onDragStart:"&",onDrag:"&",onRelease:"&",onRefreshChange:"&",onHiding:"&",onFinish:"&"},controller:["$scope",function(e){this.addListener=function(n){e.listener=n}}],link:function(n,t,s,r){function o(e,t){if(n.listener&&n.listener[e]){var s=new Event(e,{cancelable:!0});s.params=t;var r=n.listener[e].apply(n.listener,[s]);if(s.defaultPrevented)return r}return n[e]?n[e].apply(n,[t]):void 0}function a(e){if("ion-content"===e[0].localName)return e;var n=e.parent();return n?a(n):null}function i(){C&&(n.listener=null,e.off(C.start,"dragstart",h),e.off(C.down,"dragdown",u),e.off(C.end,"dragend",m),t.off("transitionend",d),t.off("$destroy",i))}function l(){if(R=a(t),!R)throw new Error("Refresher must be a child of ion-content");x=angular.element(t[0].querySelector(".mos-rotate")),t.on("$destroy",i),C={start:e.on("dragstart",h,R),down:e.on("dragdown",u,R),end:e.on("dragend",m,R),transitionEnd:t.on("transitionend",d)},c()}function c(){t.children().addClass("mos-content"),t.addClass("mos-hidden"),v()}function d(){t.hasClass("mos-hiding")&&(t.addClass("mos-hidden"),t.removeClass("mos-hiding"),o("onFinish"))}function f(e,n){e.css({"-webkit-transform":n,"-moz-transform":n,"-ms-transform":n,transform:n})}function h(){var e=r?r.getScrollPosition().top:R[0].scrollTop;e<=T.maxStartY&&(0===x.length&&(x=angular.element(t[0].querySelector(".mos-rotate"))),w.enabled=!0,t.removeClass("mos-hidden"),t.addClass("mos-dragging"),o("onDragStart"))}function m(e){w.enabled&&(e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),w.enabled=!1,t.removeClass("mos-dragging"),f(x,""),o("onRelease"),w.mustRefresh?g():v())}function u(e){if(w.enabled){e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),w.distance=e.gesture.distance/T.resistance;var n=100*w.distance/T.distanceToRefresh;w.distance<=T.distanceToRefresh+T.extraDistance&&(p(w.distance),f(x,"rotate("+3.6*n+"deg)"),o("onDrag",{distance:w.distance,percentage:n})),w.distance>T.distanceToRefresh?w.mustRefresh||(t.addClass("mos-refresh"),w.mustRefresh=!0,o("onRefreshChange",{willRefresh:!0})):w.mustRefresh&&(t.removeClass("mos-refresh"),w.mustRefresh=!1,o("onRefreshChange",{willRefresh:!1}))}}function g(){t.addClass("mos-refreshing"),p(T.distanceToRefresh);var e=o("onRefresh");e&&e.then&&e.then(function(){v()})}function v(){n.loading=!1,w={enabled:!1,distance:0,mustRefresh:!1},t.removeClass("mos-refresh mos-refreshing mos-dragging"),t.hasClass("mos-hidden")||(t.addClass("mos-hiding"),o("onHiding")),p(0)}function p(e){f(t,"translate3d( 0, "+(e-t[0].offsetHeight-2)+"px, 0 )")}var R,x,w,C,y={distance:60,overflow:80,resistance:2.5,startPos:70},T={distanceToRefresh:parseInt(s.distance)||y.distance,overflow:parseInt(s.overflow)||y.overflow,resistance:parseFloat(s.resistance)||y.resistance,maxStartY:parseInt(s.startPos)||y.startPos};T.extraDistance=T.distanceToRefresh*T.overflow/100,l()}}}]),angular.module("mos.mobile.components").directive("mosAnimatedArrow",["$interval",function(e){return{restrict:"A",require:["mosRefresher","mosAnimatedArrow"],controller:["$scope","$element",function(n,t){function s(e,n,t,s){return[e+Math.cos(s)*t,n+Math.sin(s)*t]}var r;this.onDrag=function(e){100*(e.params.percentage/100*80-70)/10;d(e.params.percentage/100)},this.onRefresh=function(){r=e(function(){h()},15)},this.onHiding=function(){r&&e.cancel(r)};var o,a;this.init=function(e){e.addListener(this),o=t.find("canvas")[0],a=o.getContext("2d")};var i,l=2*Math.PI,c=Math.PI/2,d=function(e){var n={x:o.width/2,y:o.height/2};a.translate(n.x,n.y),a.rotate(Math.PI/2*(e-i)),a.translate(-n.x,-n.y),a.clearRect(0,0,o.width,o.height),f(o,Math.min(e,1),n,o.width/2),i=e},f=function(e,n,t,r){var o=.75*n,i=l*o-c,d=s(t.x,t.y,.5*r,i);a.beginPath(),a.arc(t.x,t.y,r-1,0,l,!1),a.strokeStyle="#CACACA",a.fillStyle="#FFFFFF",a.stroke(),a.fill(),a.beginPath(),a.fillStyle=a.strokeStyle=1>n?"rgba(100,100,100,1)":"#99CC33";var f=10;a.lineWidth=f,a.arc(t.x,t.y,.5*r,-c,i,!1),a.stroke(),a.beginPath(),a.lineWidth=1;var h=Math.max(5,15*o);a.lineTo(d[0]+Math.cos(i)*h,d[1]+Math.sin(i)*h),a.lineTo(d[0]-Math.cos(i)*h,d[1]-Math.sin(i)*h),a.lineTo(d[0]+Math.cos(i+Math.PI/2)*h,d[1]+Math.sin(i+Math.PI/2)*h),a.lineTo(d[0]+Math.cos(i)*h,d[1]+Math.sin(i)*h),a.fill()},h=function(){var e={x:o.width/2,y:o.height/2};a.translate(e.x,e.y),a.rotate(Math.PI/2*.1),a.translate(-e.x,-e.y),f(o,1,e,o.width/2)}}],link:function(e,n,t,s){var r=n.find("div");r.html("<style>mos-refresher canvas { }</style>"),r.append('<canvas width="50px" height="50px"></canvas>'),s[1].init(s[0])}}}]),angular.module("mos.mobile.components").directive("mosArrow",function(){return{restrict:"A",require:["mosRefresher","mosArrow"],controller:["$scope","$element",function(e,n){var t,s,r;this.init=function(e){e.addListener(this),t=angular.element(n[0].querySelector(".icon")),s=angular.element(n[0].querySelector(".mos-icon")),r=angular.element(n[0].querySelector(".mos-refresher-text"))},this.onRefreshChange=function(n){r.html(n.params.willRefresh?e.releaseText:e.pullText)},this.onRefresh=function(){t.addClass("ion-load-c").removeClass("ion-arrow-down-a"),s.addClass("mos-rotate"),r.html(e.loadingText)},this.onFinish=function(){s.removeClass("mos-rotate"),t.removeClass("ion-load-c").addClass("ion-arrow-down-a"),r.html(e.pullText)},this.onRelease=function(){r.html(e.pullText)}}],link:function(e,n,t,s){var r=n.find("div");e.pullText=t.pullText||"Pull To Refresh",e.releaseText=t.releaseText||"Release To Refresh",e.loadingText=t.loadingText||"Loading";var o=t.iconSize||50;n.addClass("mos-arrow"),r.html('<div class="mos-icon"><i style="font-size: '+o+'px;" class="icon ion-arrow-down-a"></i></div><span class="mos-refresher-text">'+e.pullText+"</span>"),s[1].init(s[0])}}}),angular.module("mos.mobile.components").directive("mosSpinningIcon",function(){return{restrict:"A",require:"mosRefresher",link:function(e,n,t){var s=n.find("div"),r=t.mosSpinningIcon||"ion-ios7-refresh",o=t.iconRefreshColor||"#0D0BA4",a=t.iconSize||"#0D0BA4";n.addClass("mos-spinning-icon"),s.html("<style>mos-refresher.mos-spinning-icon .icon { font-size: "+a+"px; } mos-refresher.mos-spinning-icon.mos-refresh .icon { color: "+o+"; }</style>"),s.append('<div class="mos-rotate"><i class="icon '+r+'"></i></div>')}}});