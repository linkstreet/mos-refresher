angular.module("mos.mobile.components",[]).constant("MOS_REFRESHER_CONFIG",{defaults:{distance:60,overflow:80,resistance:2.5,startPos:70},hidingTime:300}).directive("mosRefresher",["$ionicGesture","$timeout","MOS_REFRESHER_CONFIG",function(e,n,s){return{restrict:"E",template:"<div ng-transclude></div>",require:"?^$ionicScroll",transclude:!0,scope:{onRefresh:"&",onDragStart:"&",onDrag:"&",onRelease:"&",onRefreshChange:"&",onHiding:"&",onFinish:"&"},controller:["$scope",function(e){this.addListener=function(n){e.listener=n}}],link:function(r,t,o,i){function a(e,n){if(r.listener&&r.listener[e]){var s=new Event(e,{cancelable:!0});s.params=n;var t=r.listener[e].apply(r.listener,[s]);if(s.defaultPrevented)return t}return r[e]?r[e].apply(r,[n]):void 0}function d(e){if("ion-content"===e[0].localName)return e;var n=e.parent();return n?d(n):null}function l(){E&&(r.listener=null,T&&n.cancel(T),e.off(E.start,"dragstart",h),e.off(E.down,"dragdown",v),e.off(E.end,"dragend",g),t.off("transitionend",m),t.off("$destroy",l))}function c(){if(w=d(t),!w)throw new Error("Refresher must be a child of ion-content");S=angular.element(t[0].querySelector(".mos-rotate")),t.on("$destroy",l),E={start:e.on("dragstart",h,w),down:e.on("dragdown",v,w),end:e.on("dragend",g,w),transitionEnd:t.on("transitionend",m)},f()}function f(){t.children().addClass("mos-content"),t.addClass("mos-hidden"),R()}function m(e){t.hasClass("mos-hiding")&&(e&&T&&n.cancel(T),t.addClass("mos-hidden"),t.removeClass("mos-hiding"),a("onFinish"))}function u(e,n){e.css({"-webkit-transform":n,"-moz-transform":n,"-ms-transform":n,transform:n})}function h(){var e=i?i.getScrollPosition().top:w[0].scrollTop;e<=F.maxStartY&&(0===S.length&&(S=angular.element(t[0].querySelector(".mos-rotate"))),D.enabled=!0,t.removeClass("mos-hidden"),t.addClass("mos-dragging"),a("onDragStart"),b=t[0].offsetHeight)}function g(e){D.enabled&&(e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),D.enabled=!1,t.removeClass("mos-dragging"),u(S,""),a("onRelease"),b=t[0].offsetHeight,D.mustRefresh?p():R())}function v(e){if(D.enabled){e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),D.distance=e.gesture.distance/F.resistance;var n=100*D.distance/F.distanceToRefresh;D.distance<=F.distanceToRefresh+F.extraDistance&&(C(D.distance),u(S,"rotate("+3.6*n+"deg)"),a("onDrag",{distance:D.distance,percentage:n})),D.distance>F.distanceToRefresh?D.mustRefresh||(t.addClass("mos-refresh"),D.mustRefresh=!0,a("onRefreshChange",{willRefresh:!0})):D.mustRefresh&&(t.removeClass("mos-refresh"),D.mustRefresh=!1,a("onRefreshChange",{willRefresh:!1}))}}function p(){t.addClass("mos-refreshing"),C(F.distanceToRefresh);var e=a("onRefresh");e&&e.then&&e.then(function(){R()})}function R(){r.loading=!1,D={enabled:!1,distance:0,mustRefresh:!1},t.removeClass("mos-refresh mos-refreshing mos-dragging"),t.hasClass("mos-hidden")||(t.addClass("mos-hiding"),T=n(m,s.hidingTime),a("onHiding")),C(0)}function C(e){var n=t[0].offsetHeight;0===n&&(n=b),u(t,"translate3d( 0, "+(e-b-2)+"px, 0 )")}var w,S,D,E,b,T,y=s.defaults,F={distanceToRefresh:parseInt(o.distance)||y.distance,overflow:parseInt(o.overflow)||y.overflow,resistance:parseFloat(o.resistance)||y.resistance,maxStartY:parseInt(o.startPos)||y.startPos};F.extraDistance=F.distanceToRefresh*F.overflow/100,c()}}}]),angular.module("mos.mobile.components").directive("mosSpinningIcon",function(){return{restrict:"A",require:"mosRefresher",link:function(e,n,s){var r=n.find("div"),t=s.mosSpinningIcon||"ion-ios7-refresh",o=s.iconRefreshColor||"#0D0BA4",i=s.iconSize||"#0D0BA4";n.addClass("mos-spinning-icon"),r.html("<style>mos-refresher.mos-spinning-icon .icon { font-size: "+i+"px; } mos-refresher.mos-spinning-icon.mos-refresh .icon { color: "+o+"; }</style>"),r.append('<div class="mos-rotate"><i class="icon '+t+'"></i></div>')}}});